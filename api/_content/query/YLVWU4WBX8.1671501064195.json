[{"_path":"/plugins/spf","_dir":"plugins","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"spf - SPF plugin for Haraka","description":"Haraka spf plugin that implements SPF checks","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"spf-plugin"},"children":[{"type":"text","value":"SPF plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin implements RFC 4408 Sender Policy Framework (SPF)\nSee the "},{"type":"element","tag":"a","props":{"href":"http://en.wikipedia.org/wiki/Sender_Policy_Framework","rel":["nofollow"]},"children":[{"type":"text","value":"Wikipedia article on SPF"}]},{"type":"text","value":" for details."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By default this plugin with only add trace Received-SPF headers to a message.\nTo make it reject mail then you will need to enable the relevant options below.\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"[deny]helo_fail"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"[deny]mfrom_fail"}]},{"type":"text","value":" are the closest match for the intent\nof SPF but you will need to whitelist any hosts forwarding mail from another\ndomain whilst preserving the original return-path."}]},{"type":"element","tag":"h2","props":{"id":"configuration"},"children":[{"type":"text","value":"Configuration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin uses spf.ini for configuration and the following options are\navailable:"}]},{"type":"element","tag":"code","props":{"code":"[relay]\ncontext=sender   (default: sender)\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[relay]\ncontext=sender   (default: sender)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"On connections with relaying privileges (MSA or mail relay), it is often\ndesirable to evaluate SPF from the context of Haraka's public IP(s), in the\nsame fashion the next mail server will evaluate it when we send to them.\nIn that use case, Haraka should use context=myself."}]},{"type":"element","tag":"code","props":{"code":"* context=sender    evaluate SPF based on the sender (connection.remote.ip)\n* context=myself    evaluate SPF based on Haraka's public IP\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"* context=sender    evaluate SPF based on the sender (connection.remote.ip)\n* context=myself    evaluate SPF based on Haraka's public IP\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The rest of the optional settings (disabled by default) permit deferring or\ndenying mail from senders whose SPF fails the checks."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Additional settings allow you to control the small things (defaults are shown):"}]},{"type":"element","tag":"code","props":{"code":"; The lookup timeout, in seconds. Better set it to something much lower than this.\nlookup_timeout = 29\n\n; bypass hosts that match these conditions\n[skip]\n; hosts that relay through us\nrelaying = false\n; hosts that are SMTP AUTH'ed\nauth = false\n","language":"ini"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"; The lookup timeout, in seconds. Better set it to something much lower than this.\nlookup_timeout = 29\n\n; bypass hosts that match these conditions\n[skip]\n; hosts that relay through us\nrelaying = false\n; hosts that are SMTP AUTH'ed\nauth = false\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There's a special setting that would allow the plugin to emit a funny explanation text on SPF DENY, essentially meant to be visible to end-users that will receive the bounce. The text is "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"http://www.openspf.org/Why?s=${scope}&id=${sender_id}&ip=${connection.remote.ip}"}]},{"type":"text","value":" and is enabled by:"}]},{"type":"element","tag":"code","props":{"code":"[deny]\nopenspf_text = true\n\n; in case you DENY on failing SPF on hosts that are relaying (but why?)\n[deny_relay]\nopenspf_text = true\n","language":"ini"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[deny]\nopenspf_text = true\n\n; in case you DENY on failing SPF on hosts that are relaying (but why?)\n[deny_relay]\nopenspf_text = true\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"things-to-know"},"children":[{"type":"text","value":"Things to Know"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Most senders do not publish SPF records for their mail server "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"hostname"}]},{"type":"text","value":",\nwhich means that the SPF HELO test rarely passes. During observation in 2014,\nmore spam senders have valid SPF HELO than ham senders. If you expect very\nlittle from SPF HELO validation, you might still be disappointed."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Enabling error deferrals will cause excessive delays and perhaps bounced\nmail for senders with broken DNS. Enable this only if you are willing to\ndelay and sometimes lose valid mail."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Broken SPF records by valid senders are common. Keep that in mind when\nconsidering denial of SPF error results. If you deny on error, budget\ntime for instructing senders on how to correct their SPF records so they\ncan email you."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The only deny option most sites should consider is "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mfrom_fail"}]},{"type":"text","value":". That will\nreject messages that explicitely fail SPF tests. SPF failures have a high\ncorrelation with spam. However, up to 10% of ham transits forwarders and/or\nemail lists which frequently break SPF. SPF results are best used as inputs\nto other plugins such as DMARC, "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/manual/plugins/spamassassin.html","rel":["nofollow"]},"children":[{"type":"text","value":"spamassassin"}]},{"type":"text","value":", and "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/manual/plugins/karma.html","rel":["nofollow"]},"children":[{"type":"text","value":"karma"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Heed well the implications of SPF, as described in "},{"type":"element","tag":"a","props":{"href":"http://tools.ietf.org/html/rfc4408#section-9.3","rel":["nofollow"]},"children":[{"type":"text","value":"RFC 4408"}]}]}]},{"type":"element","tag":"code","props":{"code":"[defer]\nhelo_temperror\nmfrom_temperror\n\n[deny]\nhelo_none\nhelo_softfail\nhelo_fail\nhelo_permerror\n\nmfrom_none\nmfrom_softfail\nmfrom_fail\nmfrom_permerror\n\nopenspf_text\n\n; SPF settings used when connection.relaying=true\n[defer_relay]\nhelo_temperror\nmfrom_temperror\n\n[deny_relay]\nhelo_none\nhelo_softfail\nhelo_fail\nhelo_permerror\n\nmfrom_none\nmfrom_softfail\nmfrom_fail\nmfrom_permerror\n\nopenspf_text\n","language":"ini"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[defer]\nhelo_temperror\nmfrom_temperror\n\n[deny]\nhelo_none\nhelo_softfail\nhelo_fail\nhelo_permerror\n\nmfrom_none\nmfrom_softfail\nmfrom_fail\nmfrom_permerror\n\nopenspf_text\n\n; SPF settings used when connection.relaying=true\n[defer_relay]\nhelo_temperror\nmfrom_temperror\n\n[deny_relay]\nhelo_none\nhelo_softfail\nhelo_fail\nhelo_permerror\n\nmfrom_none\nmfrom_softfail\nmfrom_fail\nmfrom_permerror\n\nopenspf_text\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"testing"},"children":[{"type":"text","value":"Testing"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin also provides a command-line test tool that can be used to debug SPF issues or to check results."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To check the SPF record for a domain:"}]},{"type":"element","tag":"code","props":{"code":"# spf --ip 1.2.3.4 --domain fsl.com\nip=1.2.3.4 helo=\"\" domain=\"fsl.com\" result=Fail\n","language":"sh"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# spf --ip 1.2.3.4 --domain fsl.com\nip=1.2.3.4 helo=\"\" domain=\"fsl.com\" result=Fail\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To check the SPF record for a HELO/EHLO name:"}]},{"type":"element","tag":"code","props":{"code":"# spf --ip 1.2.3.4 --helo foo.bar.com\nip=1.2.3.4 helo=\"foo.bar.com\" domain=\"\" result=None\n","language":"sh"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# spf --ip 1.2.3.4 --helo foo.bar.com\nip=1.2.3.4 helo=\"foo.bar.com\" domain=\"\" result=None\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can add "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"--debug"}]},{"type":"text","value":" to the option arguments to see a full trace of the SPF processing."}]},{"type":"element","tag":"h3","props":{"id":"spf-resource-record-type"},"children":[{"type":"text","value":"SPF Resource Record Type"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Node does not support the SPF DNS Resource Record type. Only TXT records are\nchecked."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a non-issue as < 1% (as of 2014) of SPF records use the SPF RR type.\nDue to lack of adoption, the next SPF revision will like likely deprecate the\nSPF RR type."}]}]},"navigation":{"title":"spf"},"_type":"markdown","_id":"content:8.plugins:spf.md","_source":"content","_file":"8.plugins/spf.md","_extension":"md"},{"_path":"/plugins/tarpit","_dir":"plugins","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"tarpit - Tarpit plugin","description":"Haraka tarpit plugin - Tarpit plugin","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"tarpit-plugin"},"children":[{"type":"text","value":"Tarpit plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin is designed to introduce deliberate delays on the response\nof every hook in order to slow down a connection.  It has no\nconfiguration and is designed to be used only by other plugins."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It must be loaded early in config/plugins (e.g. before any plugins\nthat accept recipients or that return OK) but must be loaded "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"after"}]},{"type":"text","value":"\nany plugins that wish to use it."}]},{"type":"element","tag":"h2","props":{"id":"usage"},"children":[{"type":"text","value":"Usage"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To use this plugin in another plugin set:"}]},{"type":"element","tag":"code","props":{"code":"connection.notes.tarpit = <seconds to delay>;\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"connection.notes.tarpit = <seconds to delay>;\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"or"}]},{"type":"element","tag":"code","props":{"code":"connection.transaction.notes.tarpit = <seconds to delay>;\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"connection.transaction.notes.tarpit = <seconds to delay>;\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"configuration"},"children":[{"type":"text","value":"Configuration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The configuration file for tarpit is config/tarpit.ini."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hooks_to_delay - a list of hooks to delay at. This setting can be used to\noverride the default list in the plugin. For example, if you notice that\nmalware is disconnecting after delaying rcpt_ok, you can remove just that\nhook from the list:"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"hooks_to_delay=connect,helo,ehlo,mail,rcpt,data,data_post,queue,unrecognized_command,vrfy,noop,rset,quit"}]},{"type":"element","tag":"h2","props":{"id":"plugin-timeout"},"children":[{"type":"text","value":"Plugin Timeout"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"config/tarpit.timeout (Default: 0)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All Haraka plugins can configure a "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"name"}]},{"type":"text","value":".timeout file. The timeout specifies\nhow long Haraka lets the plugin do nothing before it times out. When zero,\nthere is no timeout. When non-zero and "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"seconds to delay"}]},{"type":"text","value":" is longer than\ntarpit.timeout (default: 1s), you'll get errors like this in your log files:"}]},{"type":"element","tag":"code","props":{"code":"[core] Plugin tarpit timed out on hook rcpt - make sure it calls the callback\n[core] Plugin tarpit timed out on hook quit - make sure it calls the callback\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[core] Plugin tarpit timed out on hook rcpt - make sure it calls the callback\n[core] Plugin tarpit timed out on hook quit - make sure it calls the callback\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The solution is to set the contents of config/tarpit.timeout to zero or\n"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"seconds to delay"}]},{"type":"text","value":" + 1."}]},{"type":"element","tag":"h2","props":{"id":"logging"},"children":[{"type":"text","value":"Logging"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When tarpitting a command it will log 'tarpitting response for Ns' to\nthe INFO facility where N is the number of seconds."}]}]},"navigation":{"title":"tarpit"},"_type":"markdown","_id":"content:8.plugins:tarpit.md","_source":"content","_file":"8.plugins/tarpit.md","_extension":"md"}]