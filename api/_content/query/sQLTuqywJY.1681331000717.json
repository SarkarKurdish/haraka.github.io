{"_path":"/tutorials/migrating_from_v1_to_v2","_dir":"tutorials","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"Migrating from Haraka v1.x to v2.x","description":"Haraka v2.x contains two significant changes to the v1.x API related to\nstreams.","navigation":{"title":"Migrating from v1 to v2"},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"migrating-from-haraka-v1x-to-v2x"},"children":[{"type":"text","value":"Migrating from Haraka v1.x to v2.x"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Haraka v2.x contains two significant changes to the v1.x API related to\nstreams."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Streams are an abstraction over a data flow that is provided by Node core\nand is used throughout node to \"pipe\" data between two places or more. This\nmakes programming very easy, and is hence why we started using them in Haraka\nstarting with version 2.0.0."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For more information about the Stream API, see\n"},{"type":"element","tag":"a","props":{"href":"http://nodejs.org/api/stream.html","rel":["nofollow"]},"children":[{"type":"text","value":"http://nodejs.org/api/stream.html"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It's important to note that if you are using standard Haraka plugins then\nit's very unlikely you will need to change anything. Though you may want\nto configure "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"spool_dir"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"spool_after"}]},{"type":"text","value":" in "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config/smtp.ini"}]},{"type":"text","value":". However if\nyou have written custom plugins, continue reading."}]},{"type":"element","tag":"h2","props":{"id":"changes-to-look-for"},"children":[{"type":"text","value":"Changes To Look For"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Firstly, the incoming data in an email (the email body) is now stored in an\nobject which you can treat as a ReadableStream. To find if this is relevant\nfor you, look for instances of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"data_lines"}]},{"type":"text","value":" in your plugins."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Secondly, if you parse the mail body, attachments are now provided as a\nstream, rather than custom start/data/end events. To find if this is relevant\nfor you, look for instances of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"attachment_hooks"}]},{"type":"text","value":" in your plugins."}]},{"type":"element","tag":"h2","props":{"id":"fixing-data_lines-plugins"},"children":[{"type":"text","value":"Fixing data_lines plugins"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Any plugins now working on each line of data will need to change to using a\nstream. The stream is called "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"transaction.message_stream"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These changes may be complicated if you are iterating over each line and\ndoing something with the strings therein. However if you are piping the data\nto an application or over a network, your code will become significantly\nsimpler (and a lot faster)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In v1.x Haraka populated the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"transaction.data_lines"}]},{"type":"text","value":" array for each line of\ndata received.  If you were writing the data to a socket then you had to handle backpressure manually by checking the return of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"write()"}]},{"type":"text","value":" and adding\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"on('drain')"}]},{"type":"text","value":" handlers like so:"}]},{"type":"element","tag":"code","props":{"code":"var data_marker = 0;\nvar in_data = false;\nvar end_pending = true;\nvar send_data = function () {\n    in_data = true;\n    var wrote_all = true;\n    while (wrote_all && (data_marker < connection.transaction.data_lines.length)) {\n        var line = connection.transaction.data_lines[data_marker];\n        data_marker++;\n        wrote_all = socket.write(Buffer.from(line.replace(/^\\./, '..').replace(/\\r?\\n/g, '\\r\\n')), 'binary');\n        if (!wrote_all) return;\n    }\n    // we get here if wrote_all still true, and we got to end of data_lines\n    if (end_pending) {\n        end_pending = false;\n        // Finished...\n        socket.send_command('dot');\n    }\n};\nsocket.on('drain', function () {\n    if (end_pending && in_data) {\n        setImmediate(function () { send_data() });\n    }\n});\n","language":"js","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" data_marker "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" in_data "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"false"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" end_pending "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"send_data"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" () {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    in_data "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" wrote_all "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"while"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" (wrote_all "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"&&"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" (data_marker "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" connection.transaction.data_lines."}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"length"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":")) {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" line "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" connection.transaction.data_lines[data_marker];"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"        data_marker"}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"++"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"        wrote_all "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" socket."}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"write"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"(Buffer."}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"(line."}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"replace"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-16a8c5"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"^"}]},{"type":"element","tag":"span","props":{"class":"ct-66f755"},"children":[{"type":"text","value":"\\."}]},{"type":"element","tag":"span","props":{"class":"ct-16a8c5"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-16a8c5"},"children":[{"type":"text","value":"'..'"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":")."}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"replace"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-16a8c5"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"\\r"}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"?"}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"class":"ct-16a8c5"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"g"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-16a8c5"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"\\r\\n"}]},{"type":"element","tag":"span","props":{"class":"ct-16a8c5"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":")), "}]},{"type":"element","tag":"span","props":{"class":"ct-16a8c5"},"children":[{"type":"text","value":"'binary'"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"wrote_all) "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-5783c2"},"children":[{"type":"text","value":"// we get here if wrote_all still true, and we got to end of data_lines"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" (end_pending) {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"        end_pending "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"false"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-5783c2"},"children":[{"type":"text","value":"// Finished..."}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"        socket."}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"send_command"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-16a8c5"},"children":[{"type":"text","value":"'dot'"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"};"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"socket."}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"on"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-16a8c5"},"children":[{"type":"text","value":"'drain'"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" () {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" (end_pending "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"&&"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" in_data) {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"setImmediate"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" () { "}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"send_data"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"() });"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"});"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In v2.x this now becomes:"}]},{"type":"element","tag":"code","props":{"code":"connection.transaction.message_stream.pipe(socket, {dot_stuffing: true, ending_dot: true});\n","language":"js","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"connection.transaction.message_stream."}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"pipe"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"(socket, {dot_stuffing: "}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", ending_dot: "}]},{"type":"element","tag":"span","props":{"class":"ct-587260"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"});"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This automatically chunks the data, handles backpressure and will apply any\nnecessary format changes.  See "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"docs/Transaction.md"}]},{"type":"text","value":" for the full details."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you need to handle the input data by line, then you will need to create\nyour own writable stream and then pipe the message to the stream and then\nextract the lines from the stream of data.  See "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"plugins/dkim_sign.js"}]},{"type":"text","value":" for\nan example."}]},{"type":"element","tag":"h2","props":{"id":"fixing-attachment_hooks-plugins"},"children":[{"type":"text","value":"Fixing attachment_hooks plugins"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For v1.x you passed in functions to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"transaction.attachment_hooks()"}]},{"type":"text","value":" as\nfollows:"}]},{"type":"element","tag":"code","props":{"code":"transaction.attachment_hooks(\n    function (ctype, filename, body) {...}, // start\n    function (buf) {...}, // data\n    function () {...} // end\n);\n","language":"js","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"transaction."}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"attachment_hooks"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"("}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"ctype"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"filename"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"body"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":") {"}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"}, "}]},{"type":"element","tag":"span","props":{"class":"ct-5783c2"},"children":[{"type":"text","value":"// start"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"buf"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":") {"}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"}, "}]},{"type":"element","tag":"span","props":{"class":"ct-5783c2"},"children":[{"type":"text","value":"// data"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" () {"}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"} "}]},{"type":"element","tag":"span","props":{"class":"ct-5783c2"},"children":[{"type":"text","value":"// end"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":");"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That has now changed to:"}]},{"type":"element","tag":"code","props":{"code":"transaction.attachment_hooks(\n    function (ctype, filename, body, stream) {...}, // start\n);\n","language":"js","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"transaction."}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"attachment_hooks"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"("}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"ctype"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"filename"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"body"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"stream"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":") {"}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"..."}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"}, "}]},{"type":"element","tag":"span","props":{"class":"ct-5783c2"},"children":[{"type":"text","value":"// start"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":");"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This allows you to attach the stream to other streams via "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"stream.pipe(dest)"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Sometimes destination streams will apply backpressure on the sending stream,\nfor example if you are sending attachments to a remote service. In order\nfor this backpressure to apply to the connection itself (so that we don't\nhave to buffer up data in memory), we need to provide the connection object\nto the stream:"}]},{"type":"element","tag":"code","props":{"code":"var transaction = connection.transaction;\ntransaction.attachment_hooks(\n    function (ctype, filename, body, stream) {\n        stream.connection = connection;\n        ...\n    }\n);\n","language":"js","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" transaction "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" connection.transaction;"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"transaction."}]},{"type":"element","tag":"span","props":{"class":"ct-967f1e"},"children":[{"type":"text","value":"attachment_hooks"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"("}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"ctype"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"filename"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"body"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6d4cd8"},"children":[{"type":"text","value":"stream"}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"        stream.connection "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":" connection;"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-8ac48e"},"children":[{"type":"text","value":"..."}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a0ff48"},"children":[{"type":"text","value":");"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For a full example of using attachment streams, see the Transaction.md\ndocumentation file."}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-6d4cd8{color:#953800}\n.ct-5783c2{color:#6E7781}\n.ct-66f755{color:#116329}\n.ct-16a8c5{color:#0A3069}\n.ct-967f1e{color:#8250DF}\n.ct-587260{color:#0550AE}\n.ct-a0ff48{color:#24292F}\n.ct-8ac48e{color:#CF222E}\n.dark .ct-8ac48e{color:#FF7B72}\n.dark .ct-a0ff48{color:#C9D1D9}\n.dark .ct-587260{color:#79C0FF}\n.dark .ct-967f1e{color:#D2A8FF}\n.dark .ct-16a8c5{color:#A5D6FF}\n.dark .ct-66f755{color:#7EE787}\n.dark .ct-5783c2{color:#8B949E}\n.dark .ct-6d4cd8{color:#FFA657}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"changes-to-look-for","depth":2,"text":"Changes To Look For"},{"id":"fixing-data_lines-plugins","depth":2,"text":"Fixing data_lines plugins"},{"id":"fixing-attachment_hooks-plugins","depth":2,"text":"Fixing attachment_hooks plugins"}]}},"_type":"markdown","_id":"content:7.tutorials:Migrating_from_v1_to_v2.md","_source":"content","_file":"7.tutorials/Migrating_from_v1_to_v2.md","_extension":"md"}