{"_path":"/plugins/spf","_dir":"plugins","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"spf - SPF plugin for Haraka","description":"Haraka spf plugin that implements SPF checks","navigation":{"title":"spf"},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"spf-plugin"},"children":[{"type":"text","value":"SPF plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin implements RFC 4408 Sender Policy Framework (SPF)\nSee the "},{"type":"element","tag":"a","props":{"href":"http://en.wikipedia.org/wiki/Sender_Policy_Framework","rel":["nofollow"]},"children":[{"type":"text","value":"Wikipedia article on SPF"}]},{"type":"text","value":" for details."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By default this plugin with only add trace Received-SPF headers to a message.\nTo make it reject mail then you will need to enable the relevant options below.\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"[deny]helo_fail"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"[deny]mfrom_fail"}]},{"type":"text","value":" are the closest match for the intent\nof SPF but you will need to whitelist any hosts forwarding mail from another\ndomain whilst preserving the original return-path."}]},{"type":"element","tag":"h2","props":{"id":"configuration"},"children":[{"type":"text","value":"Configuration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin uses spf.ini for configuration and the following options are\navailable:"}]},{"type":"element","tag":"code","props":{"code":"[relay]\ncontext=sender   (default: sender)\n","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"[relay]\ncontext=sender   (default: sender)"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"On connections with relaying privileges (MSA or mail relay), it is often\ndesirable to evaluate SPF from the context of Haraka's public IP(s), in the\nsame fashion the next mail server will evaluate it when we send to them.\nIn that use case, Haraka should use context=myself."}]},{"type":"element","tag":"code","props":{"code":"* context=sender    evaluate SPF based on the sender (connection.remote.ip)\n* context=myself    evaluate SPF based on Haraka's public IP\n","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"* context=sender    evaluate SPF based on the sender (connection.remote.ip)\n* context=myself    evaluate SPF based on Haraka's public IP"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The rest of the optional settings (disabled by default) permit deferring or\ndenying mail from senders whose SPF fails the checks."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Additional settings allow you to control the small things (defaults are shown):"}]},{"type":"element","tag":"code","props":{"code":"; The lookup timeout, in seconds. Better set it to something much lower than this.\nlookup_timeout = 29\n\n; bypass hosts that match these conditions\n[skip]\n; hosts that relay through us\nrelaying = false\n; hosts that are SMTP AUTH'ed\nauth = false\n","language":"ini","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-601ef3"},"children":[{"type":"text","value":"; The lookup timeout, in seconds. Better set it to something much lower than this."}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"lookup_timeout"}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" = 29"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-601ef3"},"children":[{"type":"text","value":"; bypass hosts that match these conditions"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-f13fa5"},"children":[{"type":"text","value":"[skip]"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-601ef3"},"children":[{"type":"text","value":"; hosts that relay through us"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"relaying"}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" = false"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-601ef3"},"children":[{"type":"text","value":"; hosts that are SMTP AUTH'ed"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"auth"}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" = false"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There's a special setting that would allow the plugin to emit a funny explanation text on SPF DENY, essentially meant to be visible to end-users that will receive the bounce. The text is "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"http://www.openspf.org/Why?s=${scope}&id=${sender_id}&ip=${connection.remote.ip}"}]},{"type":"text","value":" and is enabled by:"}]},{"type":"element","tag":"code","props":{"code":"[deny]\nopenspf_text = true\n\n; in case you DENY on failing SPF on hosts that are relaying (but why?)\n[deny_relay]\nopenspf_text = true\n","language":"ini","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-f13fa5"},"children":[{"type":"text","value":"[deny]"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"openspf_text"}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" = true"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-601ef3"},"children":[{"type":"text","value":"; in case you DENY on failing SPF on hosts that are relaying (but why?)"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-f13fa5"},"children":[{"type":"text","value":"[deny_relay]"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"openspf_text"}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" = true"}]}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"things-to-know"},"children":[{"type":"text","value":"Things to Know"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Most senders do not publish SPF records for their mail server "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"hostname"}]},{"type":"text","value":",\nwhich means that the SPF HELO test rarely passes. During observation in 2014,\nmore spam senders have valid SPF HELO than ham senders. If you expect very\nlittle from SPF HELO validation, you might still be disappointed."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Enabling error deferrals will cause excessive delays and perhaps bounced\nmail for senders with broken DNS. Enable this only if you are willing to\ndelay and sometimes lose valid mail."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Broken SPF records by valid senders are common. Keep that in mind when\nconsidering denial of SPF error results. If you deny on error, budget\ntime for instructing senders on how to correct their SPF records so they\ncan email you."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The only deny option most sites should consider is "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mfrom_fail"}]},{"type":"text","value":". That will\nreject messages that explicitely fail SPF tests. SPF failures have a high\ncorrelation with spam. However, up to 10% of ham transits forwarders and/or\nemail lists which frequently break SPF. SPF results are best used as inputs\nto other plugins such as DMARC, "},{"type":"element","tag":"a","props":{"href":"/plugins/spamassassin"},"children":[{"type":"text","value":"spamassassin"}]},{"type":"text","value":", and "},{"type":"element","tag":"a","props":{"href":"/plugins/karma"},"children":[{"type":"text","value":"karma"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Heed well the implications of SPF, as described in "},{"type":"element","tag":"a","props":{"href":"http://tools.ietf.org/html/rfc4408#section-9.3","rel":["nofollow"]},"children":[{"type":"text","value":"RFC 4408"}]}]}]},{"type":"element","tag":"code","props":{"code":"[defer]\nhelo_temperror\nmfrom_temperror\n\n[deny]\nhelo_none\nhelo_softfail\nhelo_fail\nhelo_permerror\n\nmfrom_none\nmfrom_softfail\nmfrom_fail\nmfrom_permerror\n\nopenspf_text\n\n; SPF settings used when connection.relaying=true\n[defer_relay]\nhelo_temperror\nmfrom_temperror\n\n[deny_relay]\nhelo_none\nhelo_softfail\nhelo_fail\nhelo_permerror\n\nmfrom_none\nmfrom_softfail\nmfrom_fail\nmfrom_permerror\n\nopenspf_text\n","language":"ini","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-f13fa5"},"children":[{"type":"text","value":"[defer]"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"helo_temperror"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"mfrom_temperror"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-f13fa5"},"children":[{"type":"text","value":"[deny]"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"helo_none"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"helo_softfail"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"helo_fail"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"helo_permerror"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"mfrom_none"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"mfrom_softfail"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"mfrom_fail"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"mfrom_permerror"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"openspf_text"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-601ef3"},"children":[{"type":"text","value":"; SPF settings used when connection.relaying=true"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-f13fa5"},"children":[{"type":"text","value":"[defer_relay]"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"helo_temperror"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"mfrom_temperror"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-f13fa5"},"children":[{"type":"text","value":"[deny_relay]"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"helo_none"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"helo_softfail"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"helo_fail"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"helo_permerror"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"mfrom_none"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"mfrom_softfail"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"mfrom_fail"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"mfrom_permerror"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"openspf_text"}]}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"testing"},"children":[{"type":"text","value":"Testing"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin also provides a command-line test tool that can be used to debug SPF issues or to check results."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To check the SPF record for a domain:"}]},{"type":"element","tag":"code","props":{"code":"# spf --ip 1.2.3.4 --domain fsl.com\nip=1.2.3.4 helo=\"\" domain=\"fsl.com\" result=Fail\n","language":"sh","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-601ef3"},"children":[{"type":"text","value":"# spf --ip 1.2.3.4 --domain fsl.com"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"ip"}]},{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-b04189"},"children":[{"type":"text","value":"1.2.3.4"}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" helo"}]},{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-b04189"},"children":[{"type":"text","value":"\"\""}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" domain"}]},{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-b04189"},"children":[{"type":"text","value":"\"fsl.com\""}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" result"}]},{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-b04189"},"children":[{"type":"text","value":"Fail"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To check the SPF record for a HELO/EHLO name:"}]},{"type":"element","tag":"code","props":{"code":"# spf --ip 1.2.3.4 --helo foo.bar.com\nip=1.2.3.4 helo=\"foo.bar.com\" domain=\"\" result=None\n","language":"sh","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-601ef3"},"children":[{"type":"text","value":"# spf --ip 1.2.3.4 --helo foo.bar.com"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":"ip"}]},{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-b04189"},"children":[{"type":"text","value":"1.2.3.4"}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" helo"}]},{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-b04189"},"children":[{"type":"text","value":"\"foo.bar.com\""}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" domain"}]},{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-b04189"},"children":[{"type":"text","value":"\"\""}]},{"type":"element","tag":"span","props":{"class":"ct-c3470e"},"children":[{"type":"text","value":" result"}]},{"type":"element","tag":"span","props":{"class":"ct-e2f546"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-b04189"},"children":[{"type":"text","value":"None"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can add "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"--debug"}]},{"type":"text","value":" to the option arguments to see a full trace of the SPF processing."}]},{"type":"element","tag":"h3","props":{"id":"spf-resource-record-type"},"children":[{"type":"text","value":"SPF Resource Record Type"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Node does not support the SPF DNS Resource Record type. Only TXT records are\nchecked."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a non-issue as < 1% (as of 2014) of SPF records use the SPF RR type.\nDue to lack of adoption, the next SPF revision will like likely deprecate the\nSPF RR type."}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-b04189{color:#0A3069}\n.ct-f13fa5{color:#953800}\n.ct-c3470e{color:#24292F}\n.ct-e2f546{color:#CF222E}\n.ct-601ef3{color:#6E7781}\n.dark .ct-601ef3{color:#8B949E}\n.dark .ct-e2f546{color:#FF7B72}\n.dark .ct-c3470e{color:#C9D1D9}\n.dark .ct-f13fa5{color:#FFA657}\n.dark .ct-b04189{color:#A5D6FF}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"configuration","depth":2,"text":"Configuration","children":[{"id":"things-to-know","depth":3,"text":"Things to Know"}]},{"id":"testing","depth":2,"text":"Testing","children":[{"id":"spf-resource-record-type","depth":3,"text":"SPF Resource Record Type"}]}]}},"_type":"markdown","_id":"content:8.plugins:spf.md","_source":"content","_file":"8.plugins/spf.md","_extension":"md"}