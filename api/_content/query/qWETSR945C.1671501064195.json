[{"_path":"/core/HAProxy","_dir":"core","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"HAProxy PROXY protocol extension support","description":"Haraka natively supports the PROXY protocol 1.","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"haproxy"},"children":[{"type":"text","value":"HAProxy"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Haraka natively supports the PROXY protocol "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This allows an upstream proxy to pass IP address and port of the client which\nHaraka will use instead of the socket IP address (which is of the proxy).\nThis allows DNSBLs and access control lists to operate on the proxied address."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Support is disabled by default and if HAProxy or other attempts to send a\nPROXY command then Haraka will return a DENYSOFTDISCONNECT error.\nDENYSOFT is used to prevent configuration errors from rejecting valid mail."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To enable support for PROXY you must create a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"haproxy_hosts"}]},{"type":"text","value":" configuration\nfile which should contain a list of IP addresses of the HAProxy hosts\nthat should be allowed to send the PROXY command. A range of IP\naddresses can be specified by it's CIDR network address."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When a host connects to Haraka that matches an IP address present in the\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"haproxy_hosts"}]},{"type":"text","value":" file - a banner is not sent, instead Haraka waits for the\nPROXY command to be sent before proceeding.  The connection will timeout\nwith "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"421 PROXY timed out"}]},{"type":"text","value":" if the command is not sent within 30 seconds."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"NOTE: because Haraka does not send a banner when a listed HAProxy host\nconnects you must set check-send-proxy to ensure that the service checks\nsend a PROXY command before they run."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":" "},{"type":"element","tag":"a","props":{"href":"http://haproxy.1wt.eu/download/1.5/doc/proxy-protocol.txt","rel":["nofollow"]},"children":[{"type":"text","value":"http://haproxy.1wt.eu/download/1.5/doc/proxy-protocol.txt"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"HAProxy supports the PROXY protocol in version 1.5 or later however there\nare patches available to add support for 1.4."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is an example listener section for haproxy.cfg:"}]},{"type":"element","tag":"code","props":{"code":"listen smtp :25\n        mode tcp\n        option tcplog\n        option smtpchk\n        balance roundrobin\n        server smtp1 ip.of.haraka.server1:25 check-send-proxy check inter 10s send-proxy\n        server smtp2 ip.of.haraka.server2:25 check-send-proxy check inter 10s send-proxy\n        server smtp3 ip.of.haraka.server3:25 check-send-proxy check inter 10s send-proxy\n        server smtp4 ip.of.haraka.server4:25 check-send-proxy check inter 10s send-proxy\n        server smtp5 ip.of.haraka.server5:25 check-send-proxy check inter 10s send-proxy\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"listen smtp :25\n        mode tcp\n        option tcplog\n        option smtpchk\n        balance roundrobin\n        server smtp1 ip.of.haraka.server1:25 check-send-proxy check inter 10s send-proxy\n        server smtp2 ip.of.haraka.server2:25 check-send-proxy check inter 10s send-proxy\n        server smtp3 ip.of.haraka.server3:25 check-send-proxy check inter 10s send-proxy\n        server smtp4 ip.of.haraka.server4:25 check-send-proxy check inter 10s send-proxy\n        server smtp5 ip.of.haraka.server5:25 check-send-proxy check inter 10s send-proxy\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The important part is "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"send-proxy"}]},{"type":"text","value":" which causes HAProxy to send the PROXY\nextension on connection."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When using "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"option smtpchk"}]},{"type":"text","value":" you will see CONNRESET errors reported in the Haraka logs as\nsmtpchk drops the connection before the HELO response is still being written.\nYou can use the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"option tcp-check"}]},{"type":"text","value":" instead to provide a better service check by having\nthe check wait for the banner, send QUIT and then check the response:"}]},{"type":"element","tag":"code","props":{"code":"    option tcp-check\n    tcp-check expect rstring ^220\\ \n    tcp-check send QUIT\\r\\n\n    tcp-check expect rstring ^221\\ \n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    option tcp-check\n    tcp-check expect rstring ^220\\ \n    tcp-check send QUIT\\r\\n\n    tcp-check expect rstring ^221\\ \n"}]}]}]}]},"navigation":{"title":"HAProxy"},"_type":"markdown","_id":"content:6.core:7.HAProxy.md","_source":"content","_file":"6.core/7.HAProxy.md","_extension":"md"},{"_path":"/core/Net_Utils","_dir":"core","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Net_Utils","description":"This module provides network utility functions.","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"net_utils"},"children":[{"type":"text","value":"Net_Utils"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This module provides network utility functions."}]},{"type":"element","tag":"h2","props":{"id":"usage"},"children":[{"type":"text","value":"Usage"}]},{"type":"element","tag":"code","props":{"code":"var net_utils = require('./net_utils');\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"var net_utils = require('./net_utils');\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"ip_to_long"},"children":[{"type":"text","value":"ip_to_long"}]},{"type":"element","tag":"code","props":{"code":"// Convert IPv4 to long\nvar long = net_utils.ip_to_long('11.22.33.44');  // 185999660\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Convert IPv4 to long\nvar long = net_utils.ip_to_long('11.22.33.44');  // 185999660\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"long_to_ip"},"children":[{"type":"text","value":"long_to_ip"}]},{"type":"element","tag":"code","props":{"code":"// Convert long to IPv4\nvar ip = net_utils.long_to_ip(185999660);  // 11.22.33.44\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Convert long to IPv4\nvar ip = net_utils.long_to_ip(185999660);  // 11.22.33.44\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"dec_to_hex"},"children":[{"type":"text","value":"dec_to_hex"}]},{"type":"element","tag":"code","props":{"code":"// Convert decimal to hex\nvar hex = net_utils.dec_to_hex(20111104);  // 132df00\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Convert decimal to hex\nvar hex = net_utils.dec_to_hex(20111104);  // 132df00\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"hex_to_dec"},"children":[{"type":"text","value":"hex_to_dec"}]},{"type":"element","tag":"code","props":{"code":"// Convert hex to decimal\nvar dec = net_utils.hex_to_dec('132df00');  // 20111104\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Convert hex to decimal\nvar dec = net_utils.hex_to_dec('132df00');  // 20111104\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"is_local_ipv4"},"children":[{"type":"text","value":"is_local_ipv4"}]},{"type":"element","tag":"code","props":{"code":"// Is IPv4 address on a local network?\nnet_utils.is_local_ipv4('127.0.0.200');   // true (localhost)\nnet_utils.is_local_ipv4('169.254.0.0');   // true (link local)\nnet_utils.is_local_ipv4('226.0.0.1');     // false\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Is IPv4 address on a local network?\nnet_utils.is_local_ipv4('127.0.0.200');   // true (localhost)\nnet_utils.is_local_ipv4('169.254.0.0');   // true (link local)\nnet_utils.is_local_ipv4('226.0.0.1');     // false\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"is_private_ipv4"},"children":[{"type":"text","value":"is_private_ipv4"}]},{"type":"element","tag":"code","props":{"code":"// Is IPv4 address in RFC 1918 reserved private address space?\nnet_utils.is_private_ipv4('10.0.0.0');       // true\nnet_utils.is_private_ipv4('192.168.0.0');    // true\nnet_utils.is_private_ipv4('172.16.0.0');     // true\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Is IPv4 address in RFC 1918 reserved private address space?\nnet_utils.is_private_ipv4('10.0.0.0');       // true\nnet_utils.is_private_ipv4('192.168.0.0');    // true\nnet_utils.is_private_ipv4('172.16.0.0');     // true\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"is_local_ipv6"},"children":[{"type":"text","value":"is_local_ipv6"}]},{"type":"element","tag":"code","props":{"code":"// Is IPv6 addr on local network?\nnet_utils.is_local_ipv6('::1');           // true (localhost)\nnet_utils.is_local_ipv6('fe80::')         // true (link local)\nnet_utils.is_local_ipv6('fc00::')         // true (unique local)\nnet_utils.is_local_ipv6('fd00::')         // true (unique local)\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Is IPv6 addr on local network?\nnet_utils.is_local_ipv6('::1');           // true (localhost)\nnet_utils.is_local_ipv6('fe80::')         // true (link local)\nnet_utils.is_local_ipv6('fc00::')         // true (unique local)\nnet_utils.is_local_ipv6('fd00::')         // true (unique local)\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"is_private_ip"},"children":[{"type":"text","value":"is_private_ip"}]},{"type":"element","tag":"code","props":{"code":"// determines if an IPv4 or IPv6 address is on a \"private\" network\n// For IPv4, returns true if is_private_ipv4 or is_local_ipv4 are true\n// For IPv6, returns true if is_local_ipv6 is true\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// determines if an IPv4 or IPv6 address is on a \"private\" network\n// For IPv4, returns true if is_private_ipv4 or is_local_ipv4 are true\n// For IPv6, returns true if is_local_ipv6 is true\n"}]}]}]}]},"_type":"markdown","_id":"content:6.core:10.Net_Utils.md","_source":"content","_file":"6.core/10.Net_Utils.md","_extension":"md"}]