[{"_path":"/plugins/queue/smtp_forward","_dir":"queue","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"queue/smtp_forward - Forward mail to another SMTP server","description":"Haraka queue/smtp_forward plugin - Forward mail to another SMTP server","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"queuesmtp_forward-plugin"},"children":[{"type":"text","value":"queue/smtp_forward plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin delivers to another mail server. This is a common setup when you\nwant to have a mail server with a solid pedigree of outbound delivery to\nother hosts, and inbound delivery to users."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In comparison to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"queue/smtp_proxy"}]},{"type":"text","value":", this plugin waits until queue time to\nattempt the ongoing connection. This can be a benefit in reducing connections\nto your inbound mail server when you have content filtering (such as\nspamassassin) enabled. A possible downside is that it also delays recipient\nvalidation that the ongoing mail server may provide until queue time."}]},{"type":"element","tag":"h2","props":{"id":"configuration"},"children":[{"type":"text","value":"Configuration"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"smtp_forward.ini"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Configuration is stored in this file in the following keys:"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"enable_outbound="},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"SMTP forward outbound messages (set to false to enable Haraka's separate\nOutbound mail routing (MX based delivery))."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"host=HOST"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"The host to connect to."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"port=PORT"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"The port to connect to. Default: 25"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"connect_timeout=SECONDS"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"The maximum amount of time to wait when creating a new connection\nto the host.  Default: 30 seconds."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"timeout=SECONDS"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"The amount of seconds to let a backend connection live idle in the\nconnection pool.  This should always be less than the global plugin\ntimeout, which should in turn be less than the connection timeout."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"max_connections=NUMBER"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Maximum number of connections at any given time. Default: 1000"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"enable_tls="},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Enable TLS with the forward host (if supported). TLS uses options\nfrom the tls plugin. If key and cert are provided in the the outbound section of the tls plugin,\nthat certificate will be used as a TLS Client Certificate."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"This option controls the use of TLS via "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"STARTTLS"}]},{"type":"text","value":". This plugin does not work with\nSMTP over TLS."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"auth_type="},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"plain|login"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Enable PLAIN or LOGIN SMTP AUTH.  This is required to enable AUTH."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"auth_user=USERNAME"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"SMTP AUTH username to use."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"auth_pass=PASSWORD"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"SMTP AUTH password to use."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"queue"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Which queue plugin to use. Default: undefined. The default bahavior is to\nuse smtp_forward for inbound connections and outbound for relaying\nconnections. This option is used for complex mail routes."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"check_sender=false"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Requires that sender domains defined in smtp_forward.ini (see Per-Domain below) have relaying privileges. This is a form of spoof prevention and assumes that any mail clients have relaying or AUTH privileges. This is usually the case."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"check_recipient=false"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"By default, Haraka accepts no emails until a recipient plugin has been configured to accept mails for a domain. The simplest common case is the in_host_list plugin with a list of domains in config/host_list. An alternative is to set "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"check_recipient=true"}]},{"type":"text","value":" and list each domain in a definition block in smtp_forward.ini (see Per-Domain Configuration). An example for two domains:"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"example.com"}]},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"example.net"}]}]}]}]}]},{"type":"element","tag":"h1","props":{"id":"per-domain-configuration"},"children":[{"type":"text","value":"Per-Domain Configuration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"More specific forward routes for domains can be defined. The domain is\nchosen based on the value of the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"domain_selector"}]},{"type":"text","value":" config variable."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"domain_selector"}]},{"type":"text","value":" is set to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"rcpt_to"}]},{"type":"text","value":" (the default), more specific\nroutes are only honored for SMTP connections with a single recipient or SMTP\nconnections where every recipient host is identical."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"domain_selector"}]},{"type":"text","value":" is set to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mail_from"}]},{"type":"text","value":", the domain of the MAIL FROM\naddress is used."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"enable_outbound can be set or unset on a per-domain level to enable or disable\nforwarding for specific domains."}]},{"type":"element","tag":"code","props":{"code":"# default SMTP host\nhost=1.2.3.4\n# auth_type=plain\n# auth_user=user\n# auth_user=pass\n\n[example1.com]\nhost=1.2.3.5\n# auth_type=plain\n# auth_user=user\n# auth_pass=pass\n\n[example2.com]\nhost=1.2.3.5\n\n[example3.com]\nhost=1.2.3.6\n\n[example4.com]\nenable\\_outbound=false\n","language":"ini"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# default SMTP host\nhost=1.2.3.4\n# auth_type=plain\n# auth_user=user\n# auth_user=pass\n\n[example1.com]\nhost=1.2.3.5\n# auth_type=plain\n# auth_user=user\n# auth_pass=pass\n\n[example2.com]\nhost=1.2.3.5\n\n[example3.com]\nhost=1.2.3.6\n\n[example4.com]\nenable\\_outbound=false\n"}]}]}]},{"type":"element","tag":"h1","props":{"id":"split-host-forward-routing"},"children":[{"type":"text","value":"Split host forward routing"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When an incoming email transaction has multiple recipients with different forward routes,  recipients to subsequent forward routes are deferred. Example: an incoming email transaction has recipients "},{"type":"element","tag":"a","props":{"href":"mailto:user@example1.com"},"children":[{"type":"text","value":"user@example1.com"}]},{"type":"text","value":", "},{"type":"element","tag":"a","props":{"href":"mailto:user@example2.com"},"children":[{"type":"text","value":"user@example2.com"}]},{"type":"text","value":", and "},{"type":"element","tag":"a","props":{"href":"mailto:user@example3.com"},"children":[{"type":"text","value":"user@example3.com"}]},{"type":"text","value":". The first two recipients will be accepted (they share the same forward destination) and the latter will be deferred. It will arrive in a future delivery attempt by the remote."}]}]},"navigation":{"title":"queue/smtp_forward"},"_type":"markdown","_id":"content:8.plugins:queue:smtp_forward.md","_source":"content","_file":"8.plugins/queue/smtp_forward.md","_extension":"md"},{"_path":"/plugins/rate_limit","_dir":"plugins","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"rate_limit - Rate limit connections plugin for Haraka","description":"Haraka rate_limit plugin - Rate limit connections","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"rate_limit-plugin"},"children":[{"type":"text","value":"rate_limit plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Enforce limits on connection concurrency, connection rate, and recipient rate."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By default DENYSOFT will be returned when the limits are exceeded, but for\nconcurrency, connection rate and recipient rate by host you can optionally\ntarpit the connection by adding a delay before every response sent back to the\nclient instead of sending a DENYSOFT.  To do this requires the 'tarpit' plugin\nto run immediately after this plugin."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To use this plugin you will need a Redis server and will need the redis,\nhiredis and ipaddr.js packages installed via:"}]},{"type":"element","tag":"code","props":{"code":"cd /path/to/haraka/home\nnpm install redis hiredis ipaddr.js\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"cd /path/to/haraka/home\nnpm install redis hiredis ipaddr.js\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"configuration"},"children":[{"type":"text","value":"Configuration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin uses the configuration file rate_limit.ini which is checked for\nupdates before each hook, so changes to this file will never require a restart\nand will take effect seconds after the changes are saved."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The configuration options for each heading are detailed below:"}]},{"type":"element","tag":"h3","props":{"id":"main"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"main"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"redis_server = <ip | host>"},{"type":"element","tag":"span","props":{},"children":[{"type":"element","tag":"port","props":{},"children":[]}]},{"type":"text","value":" "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"(optional)"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"If port is missing then it defaults to 6379."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nIf this setting is missing entirely then it defaults to 127.0.0.1:6379."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Note that Redis does not currently support IPv6."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"tarpit_delay = seconds "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"(optional)"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Set this to the length in seconds that you want to delay every SMTP\nresponse to a remote client that has exceeded the rate limits.  For this\nto work the 'tarpit' plugin must be loaded "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"after"}]},{"type":"text","value":" this plugin in\nconfig/plugins."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"If 'tarpit' is not loaded or is loaded before this plugin, then no\nrate throttling will occur."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All of the following sections are optional.  Any missing section disables\nthat particular test."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"They all use a common configuration format:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"<lookup> = <limit>"},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"/time"},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"unit"}]}]},{"type":"text","value":"  "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"(optional)"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"'lookup' is based upon the limit being enforced and is either an IP\naddress, rDNS name, sender address or recipient address either in full\nor part."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nThe lookup order is as follows and the first match in this order is\nreturned and is used as the record key in Redis (except for 'default'\nwhich always uses the full lookup for that test as the record key):"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"IPv4/IPv6 address or rDNS hostname:"}]},{"type":"text","value":" "},{"type":"element","tag":"pre","props":{},"children":[{"type":"text","value":" fe80:0:0:0:202:b3ff:fe1e:8329\n fe80:0:0:0:202:b3ff:fe1e\n fe80:0:0:0:202:b3ff\n fe80:0:0:0:202\n fe80:0:0:0\n fe80:0:0\n fe80:0\n fe80\n 1.2.3.4\n 1.2.3\n 1.2\n 1\n host.part.domain.com\n part.domain.com\n domain.com\n com\n default\n "}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Sender or Recipient address:"}]},{"type":"text","value":" "},{"type":"element","tag":"pre","props":{},"children":[{"type":"text","value":" user@host.sub.part.domain.com\n host.sub.part.domain.com\n sub.part.domain.com\n part.domain.com\n domain.com\n com\n default\n "}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"In all tests 'default' is used to specify a default limit if nothing else has\nmatched."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"'limit' specifies the limit for this lookup.  Specify 0 (zero) to disable\nlimits on a matching lookup."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"'time' is optional and if missing defaults to 60 seconds.  You can optionally\nspecify the following time units (case-insensitive):"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"s (seconds)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"m (minutes)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"h (hours)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"d (days)"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"concurrency"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"concurrency"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"IMPORTANT NOTE:"}]},{"type":"text","value":" connection concurrency is recorded in-memory (in\nconnection.server.notes) and not in Redis, so the limits are per-server and\nper-child if you use the cluster module."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"IP and rDNS names are looked up by this test.  This section does "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"not"}]},{"type":"text","value":" accept an\ninterval.  It's a hard limit on the number of connections and not based on time."}]},{"type":"element","tag":"h3","props":{"id":"rate_conn"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"rate_conn"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section limits the number of connections per interval from a given host\nor set of hosts."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"IP and rDNS names are looked up by this test."}]},{"type":"element","tag":"h3","props":{"id":"rate_rcpt_host"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"rate_rcpt_host"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section limits the number of recipients per interval from a given host or\nset of hosts."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"IP and rDNS names are looked up by this test."}]},{"type":"element","tag":"h3","props":{"id":"rate_rcpt_sender"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"rate_rcpt_sender"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section limits the number of recipients per interval from a sender or\nsender domain."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The sender is looked up by this test."}]},{"type":"element","tag":"h3","props":{"id":"rate_rcpt"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"rate_rcpt"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section limits the rate which a recipient or recipient domain can\nreceive messages over an interval."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Each recipient is looked up by this test."}]},{"type":"element","tag":"h3","props":{"id":"rate_rcpt_null"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"rate_rcpt_null"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section limits the rate at which a recipient can receive messages from\na null sender (e.g. DSN, MDN etc.) over an interval."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Each recipient is looked up by this test."}]}]},"navigation":{"title":"rate_limit"},"_type":"markdown","_id":"content:8.plugins:rate_limit.md","_source":"content","_file":"8.plugins/rate_limit.md","_extension":"md"}]