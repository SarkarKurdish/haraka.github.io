[{"_path":"/plugins/connect.asn","_dir":"plugins","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"connect.asn - get AS number of remote IP address plugin for Haraka","description":"Haraka connect.asn plugin - get AS number of remote","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"connectasn-plugin"},"children":[{"type":"text","value":"connect.asn plugin"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use DNS queries to look up the ASN of the remote IP."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Inserts a result object with the ASN of the remote host."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The AS Number is the "},{"type":"element","tag":"a","props":{"href":"http://en.wikipedia.org/wiki/Autonomous_System_(Internet)","rel":["nofollow"]},"children":[{"type":"text","value":"Autonomous System Number"}]},{"type":"text","value":"\nthat represents the bailiwick or sphere of control of a network operator."}]},{"type":"element","tag":"h2","props":{"id":"faster-lookups"},"children":[{"type":"text","value":"Faster Lookups"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If your mail server is very busy:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Download the "},{"type":"element","tag":"a","props":{"href":"ftp://ftp.routeviews.org/dnszones/"},"children":[{"type":"text","value":"routeviews ASN zones"}]},{"type":"text","value":" and serve them on a local DNS server. If you use SpamAssassin, this is highly recommended as it looks up ASN using routeviews via DNS."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Use instead the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"connect.geoip"}]},{"type":"text","value":" plugin with the MaxMind backend. It caches the ASN database locally and gets the ASN without network traffic and delays."}]}]},{"type":"element","tag":"h2","props":{"id":"usage"},"children":[{"type":"text","value":"Usage"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The AS number can be accessed by plugins that run after "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"connect.asn"}]},{"type":"text","value":" like so:"}]},{"type":"element","tag":"code","props":{"code":"var asn = connection.results.get('connect.asn');\nif (asn && asn.asn) {\n    connection.loginfo(plugin, \"hey look, it's ASN: \" + asn.asn);\n}\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"var asn = connection.results.get('connect.asn');\nif (asn && asn.asn) {\n    connection.loginfo(plugin, \"hey look, it's ASN: \" + asn.asn);\n}\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"configuration"},"children":[{"type":"text","value":"Configuration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The following settings can be set in config/connect.asn.ini."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"providers: comma separated list of DNS zones that provide IP to ASN lookups"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"origin.asn.cymru.com"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"origin.asn.spameatingmonkey.net"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"asn.routeviews.org"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"test_ip: (Default:"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"An IP address that maps to an ASN (any valid public IP should work)"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"timeout (in seconds): (Default: 4)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"How long to wait for DNS results to return."}]},{"type":"element","tag":"h2","props":{"id":"headers"},"children":[{"type":"text","value":"Headers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Optionally add headers to messages with ASN info."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"asn_header (Default: false)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"add X-Haraka-ASN header with the ASN and if available, netmask."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"provider_header (Default: false)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Add X-Haraka-ASN-"},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"provider"}]},{"type":"text","value":" header for each provider that returned results."}]},{"type":"element","tag":"h2","props":{"id":"theory"},"children":[{"type":"text","value":"Theory"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"An ASN is a very good approximation of the IP space under the control\nof a network operator. The theory behind ASN tracking is that good network\noperators police their networks, proactively limit abuse, and are less likely\nto be emitting abuse."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Not-so-good network operators are likely to emit a greater number of abusive\nconnections, and should be handled with increased scrutiny."}]},{"type":"element","tag":"h2","props":{"id":"research"},"children":[{"type":"text","value":"Research"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://www.cc.gatech.edu/~feamster/papers/snare-usenix09.pdf","rel":["nofollow"]},"children":[{"type":"text","value":"http://www.cc.gatech.edu/~feamster/papers/snare-usenix09.pdf"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"\"Performance based on AS number only...The classifier gets a false positive\nrate of 0.76% "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"and"}]},{"type":"text","value":" a 70% detection rate\""}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"\"AS numbers are more persistently associated with a sender's\nidentity than the IP address, for two reasons: (1) The spamming mail server\nmight be set up within specific ASes without the network administrator\nshutting it down. (2) Bots tend to aggregate within ASes, since the machines\nin the same ASes are likely to have the same vulnerability. It is not easy for\nspammers to move mail servers or the bot armies to a different AS; therefore,\nAS numbers are robust to indicate malicious hosts.\""}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"See also: "},{"type":"element","tag":"a","props":{"href":"http://www.bgpmon.net/using-bgp-data-to-find-spammers/","rel":["nofollow"]},"children":[{"type":"text","value":"Using BGP data to find spammers"}]}]},{"type":"element","tag":"h2","props":{"id":"consumers"},"children":[{"type":"text","value":"Consumers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"a","props":{"href":"/plugins/karma"},"children":[{"type":"text","value":"karma"}]},{"type":"text","value":" plugin uses the ASN to maintain\nits network neighborhood reputation."}]}]},"navigation":{"title":"connect.asn"},"_type":"markdown","_id":"content:8.plugins:connect.asn.md","_source":"content","_file":"8.plugins/connect.asn.md","_extension":"md"},{"_path":"/plugins/connect.geoip","_dir":"plugins","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"geoip - GeoIP lookup","description":"Haraka geoip plugin - GeoIP lookup","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"geoip-plugin"},"children":[{"type":"text","value":"geoip plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"provide geographic information about mail senders."}]},{"type":"element","tag":"h1","props":{"id":"synopsis"},"children":[{"type":"text","value":"SYNOPSIS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Use MaxMind's GeoIP databases to report geographic information about senders. This plugin has support for both the "},{"type":"element","tag":"a","props":{"href":"https://github.com/runk/node-maxmind","rel":["nofollow"]},"children":[{"type":"text","value":"maxmind"}]},{"type":"text","value":" and "},{"type":"element","tag":"a","props":{"href":"https://github.com/bluesmoon/node-geoip","rel":["nofollow"]},"children":[{"type":"text","value":"geoip-lite"}]},{"type":"text","value":" node modules."}]},{"type":"element","tag":"h1","props":{"id":"install"},"children":[{"type":"text","value":"INSTALL"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Install the npm geoip module you prefer:"}]},{"type":"element","tag":"code","props":{"code":"npm install maxmind\n  or\nnpm install -g geoip-lite\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"npm install maxmind\n  or\nnpm install -g geoip-lite\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If both are installed, maxmind will be preferred as it's faster and also provides ASN data. The maxmind module requires manual download of the GeoIP databases. The npm module "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"maxmind-geolite-mirror"}]},{"type":"text","value":" will download the files and keep them up-to-date if you run it periodically."}]},{"type":"element","tag":"code","props":{"code":"mkdir -p /usr/local/share/GeoIP\nnpm install -g maxmind-geolite-mirror\n/usr/local/bin/maxmind-geolite-mirror\n","language":"bash"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"mkdir -p /usr/local/share/GeoIP\nnpm install -g maxmind-geolite-mirror\n/usr/local/bin/maxmind-geolite-mirror\n"}]}]}]},{"type":"element","tag":"h1","props":{"id":"description"},"children":[{"type":"text","value":"DESCRIPTION"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"GeoIP results are stored in connection.notes.geoip and connection."},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/Haraka/blob/master/docs/Results.md","rel":["nofollow"]},"children":[{"type":"text","value":"results"}]},{"type":"text","value":" .connect.geoip. The following information is typically available:"}]},{"type":"element","tag":"code","props":{"code":"continent: NA,\ncountry:   US,\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"continent: NA,\ncountry:   US,\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If the GeoIP city database is available, the following may also be available:"}]},{"type":"element","tag":"code","props":{"code":"region:   CA,\ncity:     San Francisco,\nll:       [37.7484, -122.4156],\ndistance: 1539    // in kilometers\nrange:    [ 3479299040, 3479299071 ],\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"region:   CA,\ncity:     San Francisco,\nll:       [37.7484, -122.4156],\ndistance: 1539    // in kilometers\nrange:    [ 3479299040, 3479299071 ],\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"connect.geoip"}]},{"type":"text","value":" also adds entries like this to your logs:"}]},{"type":"element","tag":"code","props":{"code":"[connect.geoip] US\n[connect.geoip] US, WA\n[connect.geoip] US, WA, Seattle\n[connect.geoip] US, WA, Seattle, 1319km\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[connect.geoip] US\n[connect.geoip] US, WA\n[connect.geoip] US, WA, Seattle\n[connect.geoip] US, WA, Seattle, 1319km\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Calculating the distance requires the public IP of this mail server. This may\nbe the IP that Haraka is bound to. If not, make sure that "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"utils.get_public_ip"}]},{"type":"text","value":"\ncan figure it out (via STUN or in "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"smtp.ini"}]},{"type":"text","value":")."}]},{"type":"element","tag":"h1","props":{"id":"config"},"children":[{"type":"text","value":"CONFIG"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"distance"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Perform the geodesic distance calculations. Calculates the distance \"as the\ncrow flies\" from the remote mail server."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This calculation requires a 'from' IP address. This will typically be the\npublic IP of your mail server. If Haraka is bound to a private IP, net_utils\nwill attempt to determine your public IP. If that doesn't work, edit\nconfig/smtp.ini and set "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"public_ip"}]},{"type":"text","value":"."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"show_city"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"show city data in logs and headers. City data is less accurate than country."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"show_region in logs and headers. Regional data are US states, Canadian\nprovinces and such."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Set a connection result to true if the distance exceeds this many kilometers."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"too_far=4000"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"asn"}]},{"type":"text","value":"report_as"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Permits reporting the ASN as another plugin (such as connect.asn)."}]},{"type":"element","tag":"h1","props":{"id":"spam-prediction-with-distance"},"children":[{"type":"text","value":"SPAM PREDICTION WITH DISTANCE"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://www.cc.gatech.edu/~feamster/papers/snare-usenix09.pdf","rel":["nofollow"]},"children":[{"type":"text","value":"Spatio-temporal Network-level Automatic Reputation Engine"}]}]},{"type":"element","tag":"code","props":{"code":"\"For ham, 90% of the messages travel about 4,000 km or less. On the\nother hand, for spam, only 28% of messages stay within this range.\"\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"\"For ham, 90% of the messages travel about 4,000 km or less. On the\nother hand, for spam, only 28% of messages stay within this range.\"\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Observations in 2014 suggest that geodesic distance continues to be an\nexcellent predictor of spam."}]},{"type":"element","tag":"h1","props":{"id":"limitations"},"children":[{"type":"text","value":"LIMITATIONS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The distance calculations are more concerned with being fast than\naccurate. The MaxMind location data is collected from whois and is of\nlimited accuracy. MaxMind offers more accurate data for a fee."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For distance calculations, the earth is considered a perfect sphere. In\nreality, it is not. Accuracy should be within 1%."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin does not update the GeoIP databases. You may want to."}]},{"type":"element","tag":"h1","props":{"id":"see-also"},"children":[{"type":"text","value":"SEE ALSO"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"MaxMind: "},{"type":"element","tag":"a","props":{"href":"http://www.maxmind.com/","rel":["nofollow"]},"children":[{"type":"text","value":"http://www.maxmind.com/"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Databases: "},{"type":"element","tag":"a","props":{"href":"http://geolite.maxmind.com/download/geoip/database","rel":["nofollow"]},"children":[{"type":"text","value":"http://geolite.maxmind.com/download/geoip/database"}]}]},{"type":"element","tag":"h1","props":{"id":"todo"},"children":[{"type":"text","value":"TODO"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Keep an eye on node-geoip and see if they add ASN support. This would be an\nalternative to connect.asn which uses a DNS lookup to retrieve the ASN."}]}]},"navigation":{"title":"geoip"},"_type":"markdown","_id":"content:8.plugins:connect.geoip.md","_source":"content","_file":"8.plugins/connect.geoip.md","_extension":"md"}]